# SonarQube Configuration Examples

## Example: sonar-project.properties

```properties
sonar.projectKey=adusa-digital-fulfillment_ex-facilitator_sup-omni-inventory-manager-web
sonar.projectName=adusa-digital-fulfillment_ex-facilitator_sup-omni-inventory-manager-web
sonar.projectDescription=A Vue.js Micro Frontend Application for Inventory Manager
sonar.sources=src
sonar.language=ts
sonar.sourceEncoding=UTF-8
sonar.scm.provider=git
sonar.qualitygate.wait=true
sonar.javascript.lcov.reportPaths=./coverage/lcov.info
sonar.clover.reportPaths=./coverage/clover.xml
sonar.tests=src
sonar.test.inclusions=src/**/*.spec.ts
sonar.exclusions=src/**/*.spec.ts
sonar.coverage.exclusions=src/main.ts, src/services/**/*.ts, src/**/router/*.ts
```

## What Each Property Does

### Project Identification

#### sonar.projectKey
```properties
sonar.projectKey=adusa-digital-fulfillment_ex-facilitator_sup-omni-inventory-manager-web
```
- **Purpose**: Unique identifier for the project in SonarQube
- **Format**: `{organization}_{program}_{team}_{application-name}`
  - `adusa-digital-fulfillment`: Organization
  - `ex-facilitator`: Experience program
  - `sup-omni`: Supply chain team
  - `omni-inventory-manager-web`: Application name
- **Usage**: Used to track project across scans
- **Must be**: Unique across all SonarQube projects

#### sonar.projectName
```properties
sonar.projectName=adusa-digital-fulfillment_ex-facilitator_sup-omni-inventory-manager-web
```
- **Purpose**: Display name in SonarQube UI
- **Convention**: Usually same as projectKey
- **Visibility**: Shows in dashboards and reports
- **Can include**: Spaces and special characters (but kebab-case preferred)

#### sonar.projectDescription
```properties
sonar.projectDescription=A Vue.js Micro Frontend Application for Inventory Manager
```
- **Purpose**: Human-readable description of the project
- **Visibility**: Shows in project overview
- **Best practice**: Mention technology stack and purpose
- **Examples**:
  - "A Vue.js Micro Frontend Application for Inventory Manager"
  - "React Dashboard for Order Management"
  - "Angular SPA for Customer Portal"

### Source Code Configuration

#### sonar.sources
```properties
sonar.sources=src
```
- **Purpose**: Directory containing source code to analyze
- **Default**: Project root
- **Multiple directories**: Comma-separated `src,lib,utils`
- **Relative to**: sonar-project.properties location
- **Analyzed for**: Code smells, bugs, vulnerabilities, complexity

#### sonar.language
```properties
sonar.language=ts
```
- **Purpose**: Primary programming language
- **Options**:
  - `ts`: TypeScript
  - `js`: JavaScript
  - `py`: Python
  - `java`: Java
  - `cs`: C#
- **Auto-detection**: SonarQube can auto-detect, but explicit is better
- **Mixed projects**: Omit this property for multi-language projects

#### sonar.sourceEncoding
```properties
sonar.sourceEncoding=UTF-8
```
- **Purpose**: Character encoding of source files
- **Default**: System encoding
- **Recommended**: Always use UTF-8
- **Why**: Ensures proper parsing of special characters

### SCM Integration

#### sonar.scm.provider
```properties
sonar.scm.provider=git
```
- **Purpose**: Source control management system
- **Options**: `git`, `svn`, `mercurial`
- **Benefits**:
  - Blame information (who wrote code)
  - SCM activity metrics
  - Integration with pull requests
- **Requires**: Git repository with history

### Quality Gate

#### sonar.qualitygate.wait
```properties
sonar.qualitygate.wait=true
```
- **Purpose**: Wait for quality gate status before completing analysis
- **Options**: `true` or `false`
- **When true**:
  - Analysis waits for background tasks
  - Returns non-zero exit code if quality gate fails
  - Useful for CI/CD pipeline gates
- **When false**:
  - Analysis completes immediately
  - Check quality gate status separately

### Coverage Reports

#### sonar.javascript.lcov.reportPaths
```properties
sonar.javascript.lcov.reportPaths=./coverage/lcov.info
```
- **Purpose**: Location of LCOV coverage report
- **Format**: LCOV format (generated by Jest, Karma, etc.)
- **Multiple files**: Comma-separated paths
- **Generated by**: `npm run test:unit -- --coverage`
- **Contains**: Line coverage, branch coverage, function coverage

#### sonar.clover.reportPaths
```properties
sonar.clover.reportPaths=./coverage/clover.xml
```
- **Purpose**: Location of Clover XML coverage report
- **Format**: Clover XML format
- **Alternative to**: LCOV (can use both)
- **Generated by**: Jest with `--coverage` and clover reporter
- **Note**: Primarily for Java but supported for JavaScript

### Test Configuration

#### sonar.tests
```properties
sonar.tests=src
```
- **Purpose**: Directory containing test files
- **Convention**: Same as source for co-located tests
- **Alternative**: Separate `tests/` or `test/` directory
- **Analyzed for**: Test coverage, test count, test duplication

#### sonar.test.inclusions
```properties
sonar.test.inclusions=src/**/*.spec.ts
```
- **Purpose**: Glob pattern to identify test files
- **Format**: Ant-style glob patterns
- **Common patterns**:
  - `**/*.spec.ts`: Files ending with .spec.ts
  - `**/*.test.ts`: Files ending with .test.ts
  - `**/tests/**/*`: All files in tests directories
- **Used to**: Separate test metrics from source metrics

### Exclusions

#### sonar.exclusions
```properties
sonar.exclusions=src/**/*.spec.ts
```
- **Purpose**: Exclude files from source code analysis
- **Why**: Test files shouldn't count toward source code metrics
- **Common exclusions**:
  - `**/*.spec.ts`: Test files
  - `**/*.test.ts`: Test files
  - `**/node_modules/**`: Dependencies
  - `**/dist/**`: Build output
  - `**/coverage/**`: Coverage reports

#### sonar.coverage.exclusions
```properties
sonar.coverage.exclusions=src/main.ts, src/services/**/*.ts, src/**/router/*.ts
```
- **Purpose**: Exclude files from coverage calculations
- **Why exclude main.ts**: Bootstrap code, hard to test in isolation
- **Why exclude services**: Integration tests may not run in SonarQube context
- **Why exclude router**: Configuration code, minimal logic
- **Best practice**: Only exclude when coverage is not meaningful

**Common exclusions:**
- `src/main.ts`: Application entry point
- `src/services/**/*.ts`: API service layers
- `src/**/router/*.ts`: Router configuration
- `src/config/**/*.ts`: Configuration files
- `src/**/*.d.ts`: Type definitions
- `src/plugins/**/*.ts`: Plugin registrations

## Project Structure for SonarQube

### Required Files

#### 1. sonar-project.properties
Location: Project root
```
my-vue-app/
├── sonar-project.properties
├── package.json
├── src/
└── coverage/
```

#### 2. Coverage Reports
Location: `./coverage/` directory

Generated by Jest:
```bash
npm run test:unit -- --coverage
```

Expected files:
```
coverage/
├── lcov.info          # LCOV format
├── clover.xml         # Clover XML format
└── coverage-final.json # JSON format
```

### Jest Configuration for Coverage

#### jest.config.cjs
```javascript
module.exports = {
  collectCoverage: true,
  collectCoverageFrom: [
    'src/**/*.{js,jsx,ts,tsx,vue}',
    '!src/**/*.spec.{js,jsx,ts,tsx}',
    '!src/main.ts',
    '!src/**/router/*.ts'
  ],
  coverageReporters: ['text', 'lcov', 'clover'],
  coverageDirectory: 'coverage',
};
```

#### package.json scripts
```json
{
  "scripts": {
    "test:unit": "jest",
    "test:coverage": "jest --coverage",
    "sonar": "sonar-scanner"
  }
}
```

## Running SonarQube Analysis

### Local Analysis

#### Prerequisites
1. Install SonarScanner:
```bash
npm install -g sonar-scanner
```

2. Configure SonarQube server URL:
```bash
# Option 1: Environment variable
export SONAR_HOST_URL=https://sonarqube.example.com
export SONAR_TOKEN=your_token_here

# Option 2: Add to sonar-project.properties
sonar.host.url=https://sonarqube.example.com
sonar.login=your_token_here
```

#### Run Analysis
```bash
# Run tests with coverage
npm run test:coverage

# Run SonarScanner
sonar-scanner
```

#### Expected Output
```
INFO: Scanner configuration file: /usr/local/sonar-scanner/conf/sonar-scanner.properties
INFO: Project root configuration file: /app/sonar-project.properties
INFO: SonarScanner 4.8.0.2856
INFO: Java 11.0.17 Eclipse Adoptium (64-bit)
INFO: Analyzing on SonarQube server 9.9
INFO: Default locale: "en_US", source code encoding: "UTF-8"
INFO: Load global settings
INFO: Load global settings (done) | time=142ms
INFO: Load/download plugins
INFO: Load/download plugins (done) | time=89ms
INFO: Process project properties
INFO: Execute project builders
INFO: Execute project builders (done) | time=2ms
INFO: Project key: adusa-digital-fulfillment_ex-facilitator_sup-omni-inventory-manager-web
INFO: Base dir: /app
INFO: Working dir: /app/.scannerwork
INFO: Load project settings for component key: 'adusa-digital-fulfillment_ex-facilitator_sup-omni-inventory-manager-web'
INFO: Indexing files...
INFO: 142 files indexed
INFO: Quality profile for ts: Sonar way
INFO: Sensor TypeScript analysis [typescript]
INFO: EXECUTION SUCCESS
```

### CI/CD Integration

#### GitHub Actions
```yaml
name: SonarQube Analysis

on:
  push:
    branches: [main, develop]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  sonarqube:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Shallow clones should be disabled
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests with coverage
        run: npm run test:coverage
      
      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      
      - name: SonarQube Quality Gate check
        uses: sonarsource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
```

#### Azure DevOps
```yaml
trigger:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '22.x'
    displayName: 'Install Node.js'
  
  - script: npm ci
    displayName: 'Install dependencies'
  
  - script: npm run test:coverage
    displayName: 'Run tests with coverage'
  
  - task: SonarQubePrepare@5
    inputs:
      SonarQube: 'SonarQube-Connection'
      scannerMode: 'CLI'
      configMode: 'file'
  
  - task: SonarQubeAnalyze@5
    displayName: 'Run SonarQube Analysis'
  
  - task: SonarQubePublish@5
    inputs:
      pollingTimeoutSec: '300'
    displayName: 'Publish Quality Gate Result'
```

#### Jenkins Pipeline
```groovy
pipeline {
    agent any
    
    environment {
        SONAR_TOKEN = credentials('sonar-token')
        SONAR_HOST_URL = 'https://sonarqube.example.com'
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Install Dependencies') {
            steps {
                sh 'npm ci'
            }
        }
        
        stage('Test & Coverage') {
            steps {
                sh 'npm run test:coverage'
            }
        }
        
        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('SonarQube') {
                    sh 'sonar-scanner'
                }
            }
        }
        
        stage('Quality Gate') {
            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }
    }
}
```

### Docker Integration

#### Dockerfile with SonarQube
```dockerfile
FROM pdltoolsprdacr.azurecr.io/pdl/ubuntu-nodejs:22-stable

WORKDIR /app

COPY . .

RUN --mount=type=secret,id=vue_app_access_token \
    export VITE_ACCESS_TOKEN=$(cat /run/secrets/vue_app_access_token) && \
    echo "@RoyalAholdDelhaize:registry=https://npm.pkg.github.com" > .npmrc && \
    echo "//npm.pkg.github.com/:_authToken=${VITE_ACCESS_TOKEN}" >> .npmrc && \
    npm install

RUN rm -f .npmrc

# Run tests with coverage
RUN npm run test:coverage

# Run SonarQube analysis (if scanner is installed)
ARG SONAR_TOKEN
ARG SONAR_HOST_URL
RUN if [ -n "$SONAR_TOKEN" ] && [ -n "$SONAR_HOST_URL" ]; then \
        sonar-scanner \
        -Dsonar.login=$SONAR_TOKEN \
        -Dsonar.host.url=$SONAR_HOST_URL; \
    fi

# Continue with build...
RUN npm run build
```

## Customizing for Different Projects

### Standalone Application
```properties
sonar.projectKey=my-company_my-standalone-app
sonar.projectName=My Standalone App
sonar.projectDescription=A standalone Vue.js application
sonar.sources=src
sonar.tests=src
sonar.test.inclusions=**/*.spec.ts,**/*.test.ts
sonar.exclusions=**/*.spec.ts,**/*.test.ts
sonar.coverage.exclusions=src/main.ts
```

### Micro Frontend
```properties
sonar.projectKey=my-company_my-microfrontend
sonar.projectName=My Micro Frontend
sonar.projectDescription=A single-spa micro frontend module
sonar.sources=src
sonar.tests=src
sonar.test.inclusions=**/*.spec.ts
sonar.exclusions=**/*.spec.ts
sonar.coverage.exclusions=src/main.ts,src/set-public-path.ts
```

### Monorepo Package
```properties
sonar.projectKey=my-company_monorepo_package-name
sonar.projectName=Package Name
sonar.projectDescription=Shared component library
sonar.sources=packages/my-package/src
sonar.tests=packages/my-package/src
sonar.test.inclusions=**/packages/my-package/**/*.spec.ts
sonar.exclusions=**/packages/my-package/**/*.spec.ts
```

## Quality Gate Configuration

### Default Quality Gate
- **Coverage**: > 80%
- **Duplications**: < 3%
- **Maintainability Rating**: A
- **Reliability Rating**: A
- **Security Rating**: A
- **Security Hotspots Reviewed**: 100%

### Custom Quality Gate for Vue Apps
Recommended settings:
```
Coverage on New Code > 80%
Duplicated Lines on New Code < 3%
Maintainability Rating on New Code = A
Reliability Rating on New Code = A
Security Rating on New Code = A
Code Smells < 10
Bugs = 0
Vulnerabilities = 0
```

## Troubleshooting

### Coverage Not Showing

**Issue**: SonarQube shows 0% coverage

**Solutions:**
1. **Check coverage files exist:**
```bash
ls -la coverage/
# Should show lcov.info and clover.xml
```

2. **Verify coverage paths:**
```properties
# Use relative paths from project root
sonar.javascript.lcov.reportPaths=./coverage/lcov.info
```

3. **Run tests with coverage:**
```bash
npm run test:coverage
# Verify coverage files are generated
```

4. **Check coverage format:**
```bash
# LCOV format should contain:
head coverage/lcov.info
# TN:
# SF:/app/src/components/MyComponent.vue
# FN:10,(anonymous_0)
```

### Files Not Being Analyzed

**Issue**: Expected files not showing in SonarQube

**Solutions:**
1. **Check sonar.sources includes directory:**
```properties
sonar.sources=src
```

2. **Verify files aren't excluded:**
```properties
# Make sure patterns don't exclude too much
sonar.exclusions=**/*.spec.ts
# NOT: src/**/*
```

3. **Check file encoding:**
```properties
sonar.sourceEncoding=UTF-8
```

### Quality Gate Fails

**Issue**: Quality gate fails unexpectedly

**Solutions:**
1. **Review quality gate conditions in SonarQube UI**
2. **Check specific metric that failed**
3. **Adjust coverage exclusions if needed:**
```properties
sonar.coverage.exclusions=src/main.ts,src/config/**/*
```

### Authentication Errors

**Issue**: "Unauthorized" or "403 Forbidden"

**Solutions:**
1. **Verify token is valid:**
```bash
curl -u $SONAR_TOKEN: $SONAR_HOST_URL/api/authentication/validate
```

2. **Check token permissions:**
   - Token needs "Execute Analysis" permission
   - Project must exist or token needs "Create Projects" permission

3. **Use correct token format:**
```bash
# Environment variable
export SONAR_TOKEN=squ_1234567890abcdef

# Command line
sonar-scanner -Dsonar.login=$SONAR_TOKEN
```

## Best Practices

### 1. Always Run Tests Before Analysis
```bash
npm run test:coverage && sonar-scanner
```

### 2. Use Same Exclusions for Tests and Coverage
```properties
sonar.exclusions=**/*.spec.ts
sonar.test.inclusions=**/*.spec.ts
```

### 3. Document Coverage Exclusions
Add comments explaining why files are excluded:
```properties
# Exclude main entry point (bootstrap code)
# Exclude services (tested via integration tests)
# Exclude router (configuration only)
sonar.coverage.exclusions=src/main.ts, src/services/**/*.ts, src/**/router/*.ts
```

### 4. Set Up Quality Gate Early
Configure quality gate before first analysis to establish baseline

### 5. Integrate with Pull Requests
Enable PR decoration in SonarQube to show analysis results in PRs

### 6. Monitor Technical Debt
Regularly review and address technical debt reported by SonarQube

### 7. Use Incremental Analysis
Focus on "New Code" metrics to prevent quality degradation

## Resources

- [SonarQube Documentation](https://docs.sonarqube.org/latest/)
- [Analysis Parameters](https://docs.sonarqube.org/latest/analysis/analysis-parameters/)
- [JavaScript/TypeScript Analysis](https://docs.sonarqube.org/latest/analysis/languages/javascript/)
- [Coverage & Test Data](https://docs.sonarqube.org/latest/analysis/coverage/)
- [Quality Gates](https://docs.sonarqube.org/latest/user-guide/quality-gates/)
